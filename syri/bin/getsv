#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Mon Nov  6 14:33:37 2017

@author: goel
"""


import argparse 
import os
import sys


if __name__ == "__main__":  
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument("ref", help="path to the reference genome", type=argparse.FileType('r'))
    parser.add_argument("qry", help="path to the query genome", type=argparse.FileType('r'))
    parser.add_argument('-d', '--dir', help="path to working directory (in not current directory)", action='store', default=".")
    parser.add_argument("-p", "--prefix", help="Prefix for filenames", type=str, default="")
    parser.add_argument("--all", help="Use duplications too for variant identification",  action="store_true", default=False)
    parser.add_argument("--allow-offset", dest='offset', help='BPs allowed to overlap', default=0, type=int, action="store")
    args = parser.parse_args()
    if args.dir == ".":
        cwdPath = os.getcwd()+os.sep
    else:
        cwdPath = args.dir + os.sep
    
    prefix = args.prefix
    
    if args.all:
        fin = ["synOut.txt", "invOut.txt", "TLOut.txt", "invTLOut.txt", "dupOut.txt", "invDupOut.txt", "ctxOut.txt"]
    else:
        fin = ["synOut.txt", "invOut.txt", "TLOut.txt", "invTLOut.txt", "ctxOut.txt"]
        
    listDir = os.listdir(cwdPath)
    
    for file in fin:
        if prefix+file not in listDir:
            sys.exit(prefix+file + " is not present in the directory. Exiting")
        
    from syri.pyxFiles.synsearchFunctions import readSRData, getSV, getNotAligned

    allAlignments = readSRData(cwdPath, prefix, args.all)
    mumSNPIn = allAlignments[["aStart", "aEnd", "bStart", "bEnd", "aChr", "bChr"]].copy()
    mumSNPIn.to_csv(cwdPath+prefix+"mumSNPIn.txt", sep="\t", header=False, index=False)
    getSV(cwdPath, allAlignments, prefix, args.offset)
    getNotAligned(cwdPath, prefix, args.ref, args.qry)
